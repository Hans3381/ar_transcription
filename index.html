<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Web AR Subtitle & TTS</title>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.4/dist/mindar-face-aframe.prod.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: sans-serif;
    }
    #loading {
      position: absolute;
      width: 100%;
      height: 100%;
      background: black;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      z-index: 1000; /* Pastikan loading di atas segalanya */
    }
    .tts-controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px;
      background-color: rgba(0,0,0,0.7);
      border-radius: 10px;
      display: flex;
      gap: 10px;
      z-index: 100; /* Pastikan kontrol TTS di atas scene AR */
    }
    .tts-controls input[type="text"] {
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
      min-width: 200px;
    }
    .tts-controls button {
      padding: 8px 15px;
      border-radius: 5px;
      border: none;
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
    }
    .tts-controls button:hover {
      background-color: #45a049;
    }
  </style>
</head>

<body>
  <div id="loading">Loading...</div>

  <div class="tts-controls">
    <input type="text" id="tts-input" placeholder="Ketik teks di sini...">
    <button id="speak-button">Ucapkan</button>
  </div>

  <a-scene mindar-face="autoStart: true; filterMinCF:0.01; filterBeta:0.01;"
           embedded
           color-space="sRGB"
           renderer="antialias: true; precision: mediump; physicallyCorrectLights: true;"
           vr-mode-ui="enabled: false"
           device-orientation-permission-ui="enabled: false">

    <a-assets>
        </a-assets>

    <a-entity mindar-face-target="anchorIndex: 0">
      <a-entity id="speech-bubble-group" position="0 0.6 0"> <a-plane id="bubble-background"
                 color="#FFFFFF"
                 opacity="0.9"
                 width="0.8"
                 height="0.3"
                 position="0 0 -0.01"> </a-plane>

        <a-triangle color="#FFFFFF" opacity="0.9"
                    vertex-a="0 -0.15 0"   метров­
                    vertex-b="-0.1 -0.25 0"
                    vertex-c="0.1 -0.25 0"
                    position="0 -0.05 -0.01"> </a-triangle>

        <a-text id="subtitle-text"
                value="Mendengarkan..."
                align="center"
                color="#000000"
                width="0.75"  /* Lebar teks sedikit lebih kecil dari bubble */
                wrap-count="25" /* Jumlah karakter per baris sebelum wrap */
                position="0 0 0">
        </a-text>
      </a-entity>
    </a-entity>

    <a-camera active="true" position="0 0 0"></a-camera>
  </a-scene>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const sceneEl = document.querySelector('a-scene');
      const loadingEl = document.getElementById('loading');
      const subtitleTextEl = document.getElementById('subtitle-text');
      const bubbleBgEl = document.getElementById('bubble-background');

      // Sembunyikan loading screen setelah scene dimuat
      sceneEl.addEventListener('loaded', () => {
        if (loadingEl) {
          loadingEl.style.display = 'none';
        }
      });

      // --- Speech Recognition (Speech-to-Text) ---
      if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'id-ID'; // Bahasa Indonesia

        recognition.onresult = (event) => {
          let transcript = '';
          for (let i = event.resultIndex; i < event.results.length; i++) {
            transcript += event.results[i][0].transcript;
          }
          subtitleTextEl.setAttribute('value', transcript);

          // Sesuaikan ukuran bubble dengan teks (opsional, bisa kompleks)
          // Untuk saat ini, kita pakai ukuran tetap, tapi idealnya disesuaikan
          // Contoh sederhana: perpanjang bubble jika teks panjang
          // const textWidth = subtitleTextEl.getAttribute('geometry').width;
          // const textHeight = subtitleTextEl.getAttribute('geometry').height;
          // if (transcript.length > 20) {
          //   bubbleBgEl.setAttribute('width', 1);
          //   subtitleTextEl.setAttribute('width', 0.95);
          // } else {
          //   bubbleBgEl.setAttribute('width', 0.8);
          //    subtitleTextEl.setAttribute('width', 0.75);
          // }
        };

        recognition.onerror = (event) => {
          console.error('Speech Recognition Error: ', event.error);
          subtitleTextEl.setAttribute('value', 'Error: ' + event.error);
        };

        recognition.onend = () => {
          console.log('Speech recognition service disconnected, restarting...');
          recognition.start(); // Restart jika koneksi terputus
        };

        // Mulai speech recognition setelah AR siap (opsional, bisa langsung start)
        sceneEl.addEventListener('mindar-face-ready', () => {
          console.log("MindAR Face Ready, starting speech recognition.");
          try {
            recognition.start();
          } catch(e) {
            console.error("Error starting recognition on mindar-face-ready:", e);
            subtitleTextEl.setAttribute('value', 'Gagal memulai mic');
          }
        });
         // Fallback jika event mindar-face-ready tidak terpicu atau untuk browser desktop
        if (!sceneEl.hasLoaded) { // Jika scene belum dimuat, start recognition setelah loaded
            sceneEl.addEventListener('loaded', () => {
                 try {
                    recognition.start();
                  } catch(e) {
                    console.error("Error starting recognition on scene loaded:", e);
                    subtitleTextEl.setAttribute('value', 'Gagal memulai mic');
                  }
            });
        } else { // Jika scene sudah dimuat (mis. saat development dengan refresh cepat)
             try {
                recognition.start();
              } catch(e) {
                console.error("Error starting recognition (already loaded):", e);
                subtitleTextEl.setAttribute('value', 'Gagal memulai mic');
              }
        }


      } else {
        console.error('Speech Recognition not supported in this browser.');
        subtitleTextEl.setAttribute('value', 'Speech Recognition tidak didukung.');
      }

      // --- Text-to-Speech (TTS) ---
      const ttsInput = document.getElementById('tts-input');
      const speakButton = document.getElementById('speak-button');
      let voices = [];

      function populateVoiceList() {
        voices = window.speechSynthesis.getVoices();
        // Anda bisa uncomment ini untuk melihat daftar suara yang tersedia di konsol
        // console.log("Available voices:", voices);
      }

      populateVoiceList();
      if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = populateVoiceList;
      }

      speakButton.addEventListener('click', () => {
        const textToSpeak = ttsInput.value.trim();
        if (textToSpeak === '') {
          alert('Masukkan teks terlebih dahulu!');
          return;
        }

        if (window.speechSynthesis.speaking) {
            console.log('SpeechSynthesis.speaking');
            window.speechSynthesis.cancel(); // Batalkan ucapan sebelumnya jika ada
        }

        const utterance = new SpeechSynthesisUtterance(textToSpeak);
        utterance.lang = 'id-ID';

        // Coba cari suara Bahasa Indonesia
        const indonesianVoice = voices.find(voice => voice.lang === 'id-ID');
        if (indonesianVoice) {
          utterance.voice = indonesianVoice;
        } else {
          console.warn('Suara Bahasa Indonesia tidak ditemukan, menggunakan default.');
        }

        utterance.onerror = (event) => {
          console.error('SpeechSynthesis Utterance Error:', event.error);
          alert('Gagal mengucapkan teks: ' + event.error);
        };

        window.speechSynthesis.speak(utterance);
      });
    });
  </script>

</body>
</html>
