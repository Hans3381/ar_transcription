<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Web AR Subtitle & TTS (Kamera Belakang)</title>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mind-ar-face-aframe.min.js"></script>

  <style>
    /* ... CSS Anda tetap sama ... */
    body {
      margin: 0;
      overflow: hidden;
      font-family: sans-serif;
      background-color: #222; /* Ubah background body menjadi gelap untuk debugging */
    }
    #loading {
      position: absolute;
      width: 100%;
      height: 100%;
      background: black;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      z-index: 1000;
    }
    .tts-controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px;
      background-color: rgba(0,0,0,0.7);
      border-radius: 10px;
      display: flex;
      gap: 10px;
      z-index: 100;
    }
    .tts-controls input[type="text"] {
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
      min-width: 200px;
    }
    .tts-controls button {
      padding: 8px 15px;
      border-radius: 5px;
      border: none;
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
    }
    .tts-controls button:hover {
      background-color: #45a049;
    }
  </style>
</head>

<body>
  <div id="loading">Loading...</div>

  <div class="tts-controls">
    <input type="text" id="tts-input" placeholder="Ketik teks di sini...">
    <button id="speak-button">Ucapkan</button>
  </div>

  <a-scene mindar-face="autoStart: true; filterMinCF:0.01; filterBeta:0.01; facingMode: environment;"
           embedded
           color-space="sRGB"
           renderer="antialias: true; precision: mediump; physicallyCorrectLights: true; colorManagement: true;"
           vr-mode-ui="enabled: false"
           device-orientation-permission-ui="enabled: false">

    <a-assets>
    </a-assets>

    <a-entity mindar-face-target="anchorIndex: 0">
      <a-entity id="speech-bubble-group" position="0 0.6 0">
        <a-plane id="bubble-background"
                 color="#FFFFFF"
                 opacity="0.9"
                 width="0.8"
                 height="0.3"
                 position="0 0 -0.01">
        </a-plane>
        <a-triangle color="#FFFFFF" opacity="0.9"
                    vertex-a="0 -0.15 -0.01"
                    vertex-b="-0.1 -0.25 -0.01"
                    vertex-c="0.1 -0.25 -0.01"
                    position="0 -0.05 0">
        </a-triangle>
        <a-text id="subtitle-text"
                value="Tunggu..."
                align="center"
                color="#000000"
                width="0.75"
                wrap-count="25"
                position="0 0 0">
        </a-text>
      </a-entity>
    </a-entity>

    <a-camera active="true" position="0 0 0" wasd-controls="enabled: false"></a-camera>
  </a-scene>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const sceneEl = document.querySelector('a-scene');
      const loadingEl = document.getElementById('loading');
      const subtitleTextEl = document.getElementById('subtitle-text');
      const ttsInput = document.getElementById('tts-input');
      const speakButton = document.getElementById('speak-button');
      let voices = [];
      let recognition;

      console.log("DOMContentLoaded. Scene:", sceneEl);
      if (!sceneEl) {
          console.error("A-Frame scene element not found!");
          if(loadingEl) loadingEl.innerHTML = "Error: Scene not found!";
          return;
      }

      sceneEl.addEventListener('loaded', () => {
        console.log("A-Frame scene 'loaded' event fired.");
        if (loadingEl) {
          loadingEl.style.display = 'none';
          console.log("Loading screen hidden.");
        }

        if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
          const SpeechRecognitionAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
          recognition = new SpeechRecognitionAPI();
          recognition.continuous = true;
          recognition.interimResults = true;
          recognition.lang = 'id-ID';

          recognition.onstart = () => {
            console.log("Speech recognition started.");
            if(subtitleTextEl) subtitleTextEl.setAttribute('value', 'Mendengarkan...');
          };
          recognition.onresult = (event) => {
            let transcript = '';
            for (let i = event.resultIndex; i < event.results.length; i++) {
              transcript += event.results[i][0].transcript;
            }
            if(subtitleTextEl) subtitleTextEl.setAttribute('value', transcript);
            // console.log("Transcript:", transcript); // Bisa di-uncomment untuk debug detail
          };
          recognition.onerror = (event) => {
            console.error('Speech Recognition Error:', event.error, event.message);
            if(subtitleTextEl) subtitleTextEl.setAttribute('value', 'Mic Error: ' + event.error);
          };
          recognition.onend = () => {
            console.log('Speech recognition service disconnected.');
            if (recognition && !recognition.manualStop) {
              try {
                // console.log('Attempting to restart speech recognition...'); // Bisa di-uncomment untuk debug detail
                recognition.start();
              } catch(e) {
                console.error("Error restarting recognition onend:", e);
              }
            }
          };

          setTimeout(() => {
            try {
              console.log("Attempting to start speech recognition via setTimeout...");
              if (recognition) recognition.start();
            } catch (e) {
              console.error("Error starting speech recognition:", e);
              if (subtitleTextEl) subtitleTextEl.setAttribute('value', 'Gagal memulai mic: ' + e.message);
            }
          }, 2000);
        } else {
          console.error('Speech Recognition not supported.');
          if (subtitleTextEl) subtitleTextEl.setAttribute('value', 'Speech Rec tidak didukung.');
        }
      });

      sceneEl.addEventListener('arError', (event) => {
        console.error("MindAR AR Error Event:", event.detail);
        if (loadingEl && loadingEl.style.display !== 'none') {
          loadingEl.style.display = 'none';
        }
        let errorMessage = 'AR Error. Cek console.';
        if (event.detail && event.detail.error) {
            errorMessage = `AR Error: ${event.detail.error.name || event.detail.error.message || 'Unknown'}. Cek console.`;
        } else if (event.detail && event.detail.type) {
            errorMessage = `AR Error: ${event.detail.type}. Cek console.`;
        }
        
        if (subtitleTextEl) {
          subtitleTextEl.setAttribute('value', errorMessage);
        }
        alert(errorMessage + " Pastikan izin kamera diberikan dan coba muat ulang halaman.");
      });

      sceneEl.addEventListener('mindar-face-ready', () => {
          console.log("MindAR Face Ready event fired. AR system should be active.");
          if(subtitleTextEl) subtitleTextEl.setAttribute('value', 'AR Siap. Arahkan ke wajah.');
      });
      
      // --- Text-to-Speech (TTS) ---
      function populateVoiceList() {
        voices = window.speechSynthesis.getVoices();
      }
      populateVoiceList();
      if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = populateVoiceList;
      }
      if (speakButton && ttsInput) {
        speakButton.addEventListener('click', () => {
          const textToSpeak = ttsInput.value.trim();
          if (textToSpeak === '') { alert('Masukkan teks terlebih dahulu!'); return; }
          if (window.speechSynthesis.speaking) { window.speechSynthesis.cancel(); }
          const utterance = new SpeechSynthesisUtterance(textToSpeak);
          utterance.lang = 'id-ID';
          const indonesianVoice = voices.find(voice => voice.lang === 'id-ID' || voice.lang === 'in-ID');
          if (indonesianVoice) utterance.voice = indonesianVoice;
          else console.warn('Suara Bahasa Indonesia (id-ID/in-ID) tidak ditemukan.');
          utterance.onerror = (event) => { console.error('SpeechSynthesis Utterance Error:', event.error); alert('Gagal mengucapkan teks: ' + event.error); };
          window.speechSynthesis.speak(utterance);
        });
      } else {
          console.warn("TTS input or speak button not found.");
      }
    });
  </script>

</body>
</html>
